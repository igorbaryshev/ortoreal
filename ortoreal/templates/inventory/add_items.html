{% extends "base.html" %}
{% block title %}
  Добавить приход
{% endblock title %}
{% block content %}
  <div class="card-body">
    {% include "includes/form_errors.html" %}
    <form method="post" enctype="multipart/form-data" id="form-container">
      {% csrf_token %}
      {{ form.as_p }}
      <hr />
      {{ formset.management_form }}
      {% for item_form in formset %}
        <div class="row item-form">{% include "includes/form_fields.html" with form=item_form %}</div>
      {% endfor %}
      <div class="button-row">
        <button id="add-form" type="button" class="btn btn-secondary">+</button>
        <button id="remove-form" type="button" class="btn btn-danger">-</button>
        <div class="d-flex justify-content-end">
          <button type="submit" class="btn btn-primary">Добавить</button>
        </div>
      </div>
    </form>
  </div>
  <script>
    let itemForm = document.querySelectorAll(".item-form");
    let formNum = itemForm.length;
    if (formNum == 1) {
      $("#remove-form").hide();
      console.log("yes");
    }
    let firstForm = itemForm[0].cloneNode(true);
    console.log(firstForm);
    $(document).ready(function() {
        $('[id$="-part"').each(function() {
            $(this).select2();
        });
    });
    console.log(firstForm)
    let container = document.querySelector("#form-container");
    let addButton = document.querySelector("#add-form");
    let removeButton = document.querySelector("#remove-form");
    let totalForms = document.querySelector("#id_item-TOTAL_FORMS");
    let buttonRow = document.querySelector(".button-row");

    addButton.addEventListener('click', addForm);

    removeButton.addEventListener('click', removeForm);

    function addForm(e) {
        let itemForm = document.querySelectorAll(".item-form");
        e.preventDefault();
        console.log(itemForm);
        let newForm = firstForm.cloneNode(true);
        let formRegex = RegExp(`item-(\\d){1,3}-`,'g');

        newForm.innerHTML = newForm.innerHTML.replace(formRegex, `item-${formNum}-`);
        alerts = newForm.querySelectorAll(".alert")
        alerts.forEach(alert => {
          alert.remove();
        });
        newForm.querySelector('[name$="-warehouse"]').value = "";
        newForm.querySelector('[name$="-part"]').value = "";
        newForm.querySelector('[name$="-quantity"]').value = 0;
        container.insertBefore(newForm, buttonRow);
        $(`[name="item-${formNum}-part"]`).select2();
        formNum++;
        totalForms.setAttribute('value', `${formNum}`);
        $("#remove-form").show();
        console.log(formNum);
    }

    function removeForm(e) {
        e.preventDefault();

        let itemForm = document.querySelectorAll(".item-form");
        console.log(formNum);
        formNum--;
        let lastForm = itemForm[formNum];
        lastForm.remove();
        totalForms.setAttribute('value', `${formNum}`);
        if (formNum == 1) {
            $("#remove-form").hide();
        }
    }
  </script>
  <style>
    .select2.select2-container {
      /*width: 100% !important;*/
      margin-bottom: 26px;
    }
    .form-control {
      padding-bottom: 0;
      padding-top: 0;
      margin-bottom: 26px;
      line-height: 26px;
      border: 1px solid #aaa;
    }
    .alert {
      font-size: 15px;
      margin-bottom: 6px !important;
      margin-top: -26px !important;
    }
    .button-row {
      transition: all .1s;
    }
  </style>
{% endblock content %}
